<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - Mango Diaries</title>
    <link rel="stylesheet" href="frontend-style.css">
    <style>
        .loading-spinner {
            text-align: center;
            padding: 3rem;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--color-accent);
            border-top: 4px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .nugget-helper {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1.5rem;
            background: var(--color-secondary-bg);
            border-radius: var(--border-radius-card);
            margin: 1.5rem 0;
            border: 2px solid var(--color-accent);
        }
        
        .nugget-helper img {
            width: 60px;
            height: 60px;
            object-fit: contain;
        }
    </style>
</head>
<body>
    <header class="topbar">
        <h1><img src="assets/logo.PNG" alt="Mango" class="logo">Mango Diaries</h1>
        <a href="index.html">Back to Home</a>
    </header>

    <main class="container">
        <section class="form-card card">
            <div id="loadingState">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <h3>Setting up your password reset...</h3>
                    <p>Please wait while we verify your reset link.</p>
                </div>
            </div>
            
            <div id="successState" style="display: none;">
                <div class="success-state">
                    <div class="success-icon">✅</div>
                    <h3>Ready to Reset Your Password!</h3>
                    <p>Your reset link has been verified. You can now create a new password for your account.</p>
                    
                    <div class="nugget-helper">
                        <img src="assets/nugget.PNG" alt="Nugget the Mango">
                        <p><strong>Great!</strong> Let's get you a new password so you can get back to journaling!</p>
                    </div>
                    
                    <div style="margin-top: 2rem;">
                        <button onclick="proceedToPasswordReset()" class="button-link" style="display: inline-block; width: auto; padding: 1rem 2rem;">
                            Create New Password
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="errorState" style="display: none;">
                <div class="success-state">
                    <div class="success-icon" style="color: #ff4444;">❌</div>
                    <h3>Invalid Reset Link</h3>
                    <p>This password reset link is invalid or has expired.</p>
                    
                    <div class="nugget-helper">
                        <img src="assets/nugget.PNG" alt="Nugget the Mango">
                        <p><strong>Don't worry!</strong> You can request a new reset link and we'll send you another email.</p>
                    </div>
                    
                    <div style="margin-top: 2rem;">
                        <a href="reset-password.html" class="button-link" style="display: inline-block; width: auto; margin-right: 1rem;">
                            Get New Reset Link
                        </a>
                        <a href="signin.html" class="button-link" style="display: inline-block; width: auto;">
                            Back to Sign In
                        </a>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div id="messageBox"></div>

    <script src="firebase-config.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            verifyPasswordResetCode,
            checkActionCode
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const loadingState = document.getElementById('loadingState');
        const successState = document.getElementById('successState');
        const errorState = document.getElementById('errorState');

        let oobCode = null;
        let auth = null;

        function showMessage(message, isError = false) {
            const box = document.getElementById('messageBox');
            box.textContent = message;
            box.className = 'show';
            if (isError) box.classList.add('error');
            else box.classList.remove('error');
            setTimeout(() => { box.classList.remove('show'); }, 5000);
        }

        // Get OOB code from URL
        function getOobCodeFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('oobCode') || urlParams.get('mode') === 'resetPassword' && urlParams.get('oobCode');
        }

        // Get Firebase config
        function getFirebaseConfig() {
            if (window.firebaseConfig) return window.firebaseConfig;
            if (window.__firebase_config) {
                try { return JSON.parse(window.__firebase_config); } catch (e) { console.error(e); }
            }
            return {
                apiKey: "AIzaSyB-TDKJTCnIPl4wkQDXZcZvYaadjZuhelk",
                authDomain: "journal-app-bc5ce.firebaseapp.com",
                projectId: "journal-app-bc5ce",
                storageBucket: "journal-app-bc5ce.firebasestorage.app",
                messagingSenderId: "1019175672379",
                appId: "1:1019175672379:web:4062780bcc76e552421a1e",
                measurementId: "G-SFEZDN48R7"
            };
        }

        async function initializeAuth() {
            try {
                const firebaseConfig = getFirebaseConfig();
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                return auth;
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                return null;
            }
        }

        // Verify the reset code
        async function verifyResetCode(auth, code) {
            try {
                const email = await verifyPasswordResetCode(auth, code);
                console.log("Reset code verified for email:", email);
                return email;
            } catch (error) {
                console.error("Reset code verification failed:", error);
                return null;
            }
        }

        function showSuccessState() {
            loadingState.style.display = 'none';
            successState.style.display = 'block';
            errorState.style.display = 'none';
        }

        function showErrorState() {
            loadingState.style.display = 'none';
            successState.style.display = 'none';
            errorState.style.display = 'block';
        }

        // Make proceedToPasswordReset globally accessible
        window.proceedToPasswordReset = function() {
            if (oobCode) {
                window.location.href = `reset-password-complete.html?oobCode=${encodeURIComponent(oobCode)}`;
            }
        };

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("Initializing password reset handler...");
            auth = await initializeAuth();
            
            if (!auth) {
                showErrorState();
                showMessage("Authentication service unavailable.", true);
                return;
            }

            // Get OOB code from URL
            oobCode = getOobCodeFromUrl();
            if (!oobCode) {
                showErrorState();
                showMessage("Invalid reset link format.", true);
                return;
            }

            // Verify the reset code
            const email = await verifyResetCode(auth, oobCode);
            if (!email) {
                showErrorState();
                showMessage("Reset link is invalid or expired.", true);
                return;
            }

            // Code is valid, show success
            showSuccessState();
            showMessage("Reset link verified successfully!");
        });
    </script>
</body>
</html>