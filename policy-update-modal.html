<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Policy Update Required - Mango Diaries</title>
    <link rel="stylesheet" href="frontend-style.css">
    <style>
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        .policy-modal {
            background: var(--color-secondary-bg);
            padding: 2rem;
            border-radius: var(--border-radius-card);
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            margin: 1rem;
        }
        .update-required {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: var(--border-radius-card);
            padding: 1.5rem;
            margin-bottom: 2rem;
            text-align: center;
        }
        .changes-list {
            background: var(--color-main-bg);
            padding: 1.5rem;
            border-radius: var(--border-radius-card);
            margin: 1.5rem 0;
        }
        .policy-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }
        .policy-buttons button {
            flex: 1;
        }
        #viewChanges {
            background: transparent;
            border: 2px solid var(--color-accent);
        }
    </style>
</head>
<body>
    <div class="modal-overlay" id="policyModal" style="display: none;">
        <div class="policy-modal card">
            <div class="update-required">
                <h2>ðŸ”„ Policy Update Required</h2>
                <p>We've updated our policies to better serve you. Please review and accept the changes to continue using Mango Diaries.</p>
            </div>

            <div class="changes-list">
                <h3>What's New:</h3>
                <div id="changesContent">
                    <p>Loading changes...</p>
                </div>
            </div>

            <div>
                <p><strong>By clicking "Accept", you agree to our updated:</strong></p>
                <ul>
                    <li><a href="privacy-policy.html" target="_blank">Privacy Policy</a></li>
                    <li><a href="terms-of-service.html" target="_blank">Terms of Service</a></li>
                </ul>
            </div>

            <div class="policy-buttons">
                <button id="viewChanges" class="button-link" onclick="openPolicyPages()">Review Policies</button>
                <button id="acceptPolicies" class="button-link">Accept & Continue</button>
            </div>
        </div>
    </div>

    <script src="policy-manager.js"></script>
    <script>
        let currentUserId = null;

        function showPolicyUpdateModal(userId) {
            currentUserId = userId;
            document.getElementById('policyModal').style.display = 'flex';
        }

        function hidePolicyUpdateModal() {
            document.getElementById('policyModal').style.display = 'none';
        }

        function openPolicyPages() {
            window.open('privacy-policy.html', '_blank');
            window.open('terms-of-service.html', '_blank');
        }

        document.getElementById('acceptPolicies').addEventListener('click', async () => {
            const button = document.getElementById('acceptPolicies');
            button.disabled = true;
            button.textContent = 'Accepting...';

            const success = await window.policyManager.acceptPolicies(currentUserId);
            
            if (success) {
                hidePolicyUpdateModal();
                // Continue with normal app flow
                if (typeof onPolicyAccepted === 'function') {
                    onPolicyAccepted();
                }
            } else {
                button.disabled = false;
                button.textContent = 'Accept & Continue';
                alert('Failed to accept policies. Please try again.');
            }
        });

        // Function to be called by main app
        window.checkPolicyUpdates = async (userId) => {
            await window.policyManager.initialize();
            const status = await window.policyManager.checkUserPolicyStatus(userId);
            
            if (status.needsUpdate) {
                showPolicyUpdateModal(userId);
                return false; // Policies not accepted yet
            }
            return true; // Policies are up to date
        };
    </script>
</body>
</html>